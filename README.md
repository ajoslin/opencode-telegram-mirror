# OpenCode Telegram Mirror

Standalone bot that mirrors OpenCode sessions to Telegram, plus a Next.js diff viewer.

## Why Telegram?

[Telegram](https://telegram.org/) is a cloud-based messaging app known for its speed, security, and powerful bot API. Here's why it's a great fit for mirroring coding sessions:

| Feature | Benefit |
|---------|---------|
| **Cross-platform** | Native apps for iOS, Android, macOS, Windows, Linux, and web |
| **Instant sync** | Messages appear instantly across all your devices |
| **Rich formatting** | Supports Markdown, code blocks, and syntax highlighting |
| **Bot API** | First-class support for automation with no rate limit headaches |
| **Free & unlimited** | No message limits, no storage caps, no ads |
| **Notifications** | Fine-grained control over alerts per chat |

### Setting Up Telegram

1. **Download Telegram**: Get it from [telegram.org/apps](https://telegram.org/apps) or your app store.

2. **Create a bot**:
   - Message [@BotFather](https://t.me/BotFather) on Telegram
   - Send `/newbot` and follow the prompts
   - Save the API token you receive

3. **Get your chat ID**:
   - Message [@userinfobot](https://t.me/userinfobot)
   - It will reply with your user/chat ID

4. **Start a chat with your bot**: Find your bot by username and send it a message (bots can't initiate conversations).

## Quick Start

Get up and running in under a minute:

```bash
# 1. Clone and install
git clone https://github.com/your-org/opencode-telegram-mirror.git
cd opencode-telegram-mirror
bun install

# 2. Configure your Telegram bot
export TELEGRAM_BOT_TOKEN="your-bot-token"
export TELEGRAM_CHAT_ID="your-chat-id"

# 3. Run the mirror
bun run start
```

That's it! Your OpenCode sessions will now stream to Telegram.

> **Tip**: Create a Telegram bot via [@BotFather](https://t.me/BotFather) and get your chat ID by messaging [@userinfobot](https://t.me/userinfobot).

## Overview
- `src/`: Bun-based Telegram mirror bot.
- `diff-viewer/`: Next.js app for viewing diffs generated by edits.

## Requirements
- Bun 1.x for the Telegram mirror.
- Node.js 18+ for the diff viewer.

## Telegram Mirror (Root)
Install and run:
```
bun install
bun run start
```

Run from source:
```
bun run src/main.ts
```

Typecheck:
```
bun run typecheck
```

### Configuration
The bot loads configuration from, in order:
- `~/.config/opencode/telegram.json`
- `<repo>/.opencode/telegram.json`

Environment variables override file config:
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_CHAT_ID`
- `TELEGRAM_UPDATES_URL`
- `TELEGRAM_SEND_URL`

## Diff Viewer (diff-viewer/)
Install and run the dev server:
```
npm install
npm run dev
```

Build:
```
npm run build
```

Start production server:
```
npm run start
```

Lint:
```
npm run lint
```

Lint a single file:
```
npx next lint --file app/page.tsx
```

### Environment
- `VERCEL_URL` or `NEXT_PUBLIC_BASE_URL` is used to generate diff URLs.

## How It Works

```
┌─────────────────┐      ┌──────────────────┐      ┌─────────────────┐
│                 │      │                  │      │                 │
│   OpenCode      │─────▶│  Telegram Bot    │─────▶│    Telegram     │
│   Session       │      │  (Bun Runtime)   │      │    Chat         │
│                 │      │                  │      │                 │
└─────────────────┘      └────────┬─────────┘      └─────────────────┘
                                  │
                                  │ file edits
                                  ▼
                         ┌──────────────────┐      ┌─────────────────┐
                         │                  │      │                 │
                         │   Diff Viewer    │◀─────│    Vercel KV    │
                         │   (Next.js)      │      │    Storage      │
                         │                  │      │                 │
                         └──────────────────┘      └─────────────────┘
```

### Flow

1. **Session Polling**: The bot polls the OpenCode updates endpoint for new session events.

2. **Message Mirroring**: Assistant messages, tool calls, and user inputs are formatted and sent to your configured Telegram chat.

3. **Diff Generation**: When file edits occur, the bot computes a unified diff and uploads it to Vercel KV storage.

4. **Diff Viewing**: Each edit includes a link to the diff viewer, where you can see syntax-highlighted before/after comparisons.

5. **Resilient Delivery**: Messages are sent with Markdown formatting, falling back to plain text if Telegram's parser rejects the content.

## Tests
No test runner is configured in either package.
